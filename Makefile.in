NQPDIR  = <nqpdir>
MOARDLL = <libdir>/<moardll>
CONFIG  = <libnqpconf>

CC    = <cc>
RM    = <rm>
MV    = <mv>
PERL6 = perl6
CLANG = clang

COMPILE     = $(CC) <ccoptiflags> <ccswitch>
BUILD       = $(CC) <ccoptiflags> <ccout>$@
SYNTAXCHECK = $(CLANG) -std=c90 -fsyntax-only -Werror -Weverything
NOWARN      = -Wno-padded -Wno-missing-field-initializers

BINARIES  = bin/hotpatch<exe>
SOURCES   = nqp.c libnqp.c
OBJECTS   = nqp<obj> libnqp<obj>
HEADERS   = libnqp.h  moarembed.h
GENFILES  = libnqp.c
CONFFILES = Makefile gen.p6

all: bin/hotpatch<exe> libnqp<obj>

build: $(OBJECTS)

reconfig:
	$(PERL6) configure.p6 $(CONFIG)

clean:
	$(RM) $(OBJECTS)

realclean:
	$(RM) $(OBJECTS) $(BINARIES) $(GENFILES)

distclean:
	$(RM) $(OBJECTS) $(BINARIES) $(GENFILES) $(CONFFILES)

bin/hotpatch<exe>: hotpatch.c
	$(BUILD) hotpatch.c

.c<obj>: $(HEADERS)
	$(COMPILE) $*.c

libnqp<obj>: libnqp.c $(HEADERS) bin/hotpatch<exe>
	$(COMPILE) $*.c
	bin/hotpatch $@

libnqp.c: libnqp.c.in gen.p6
	$(PERL6) gen.p6 <libnqp.c.in >$@.tmp
	$(MV) $@.tmp $@

hpcheck: bin/hotpatch<exe>
	bin/hotpatch t/hp-noop.txt
	bin/hotpatch t/hp-ok.txt
	-bin/hotpatch t/hp-fail.txt
	@echo -- ok.

syntaxcheck: $(SOURCES)
	$(SYNTAXCHECK) hotpatch.c
	$(SYNTAXCHECK) $(NOWARN) $(SOURCES)
